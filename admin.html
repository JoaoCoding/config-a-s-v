<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin – Actualités Garage A.S.V</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }
    h1 { text-align: center; margin-top: 0; }
    label { font-size: 0.9rem; opacity: 0.9; }
    input, textarea {
      width: 100%;
      margin-top: .2rem;
      margin-bottom: .7rem;
      padding: .6rem .7rem;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
      font-size: .9rem;
    }
    textarea.small { min-height: 80px; resize: vertical; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: .6rem 1.1rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: .9rem;
      font-weight: 500;
      background: #22c55e;
      color: #022c22;
      margin-right: .5rem;
      margin-top: .4rem;
    }
    .btn.secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn.danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .actu-card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #020617;
    }
    .actu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .badge {
      display: inline-block;
      padding: .2rem .6rem;
      border-radius: 999px;
      background: #1f2937;
      font-size: .75rem;
      color: #9ca3af;
    }
    .info {
      font-size: .85rem;
      color: #9ca3af;
      margin-top: 0.3rem;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: .4rem;
      margin: .3rem 0;
    }
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .status {
      margin-top: 1rem;
      font-size: .85rem;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #fca5a5; }
    .row-inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.7rem;
    }
    .row-inline label {
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin – Actualités Garage A.S.V</h1>

    <!-- Auth / config locale -->
    <section id="auth-section">
      <p class="info">
        1) Choisis un <strong>mot de passe admin</strong> (ou réutilise toujours le même).<br>
        2) Colle ton <strong>token GitHub</strong> (PAT avec droit <code>repo</code>).<br>
        3) Clique sur <strong>Se connecter & charger les actus</strong>.<br>
        <br>
        <strong>Option :</strong> coche "Se souvenir" pour garder mdp + token dans ce navigateur.<br>
        ⚠️ À utiliser seulement sur ton PC perso.
      </p>

      <label>Mot de passe admin :</label>
      <input type="password" id="admin-password" placeholder="Mot de passe admin">

      <label>Token GitHub :</label>
      <input type="password" id="github-token" placeholder="ghp_...">

      <div class="row-inline">
        <input type="checkbox" id="remember-creds">
        <label for="remember-creds">Se souvenir sur ce navigateur</label>
      </div>

      <button class="btn" id="login-btn">Se connecter & charger les actus</button>
      <p id="auth-status" class="status"></p>

      <hr style="margin:1.5rem 0; border-color:#1f2937;">
    </section>

    <!-- Éditeur d'actus -->
    <section id="editor-section" style="display:none;">
      <p class="info">
        • <strong>Titre</strong>, <strong>Date</strong> (YYYY-MM-DD pour le badge “Nouveau !”),<br>
        • <strong>Paragraphes</strong> (1 par ligne),<br>
        • <strong>Promo</strong> + <strong>Code promo</strong> (affiché dans la modale sur le site).<br>
        <br>
        Quand tu as fini : clique sur <strong>Enregistrer sur GitHub</strong>.
      </p>

      <div id="actus-container"></div>
      <button class="btn secondary" id="add-actu">+ Ajouter une actualité</button>

      <h2 style="margin-top:1.5rem;">Enregistrer sur GitHub</h2>
      <button class="btn" id="save-btn">Enregistrer sur GitHub</button>
      <p id="save-status" class="status"></p>
    </section>
  </div>

  <script>
    // --- CONFIG FIXE POUR TON REPO ---
    const GITHUB_USERNAME = "JoaoCoding";
    const REPO_NAME = "config-a-s-v";
    const FILE_PATH = "actus.json";
    const BRANCH = "main";

    const STORAGE_KEY = "asv_admin_creds"; // localStorage : {password, token}

    let githubToken = null;
    let adminPassword = null; // ici c'est juste pour toi, pas envoyé à GitHub
    let currentSha = null;
    let stateActualites = [];

    const authStatus = document.getElementById("auth-status");
    const loginBtn = document.getElementById("login-btn");
    const tokenInput = document.getElementById("github-token");
    const passInput = document.getElementById("admin-password");
    const rememberCheckbox = document.getElementById("remember-creds");

    const editorSection = document.getElementById("editor-section");
    const actusContainer = document.getElementById("actus-container");
    const addActuBtn = document.getElementById("add-actu");
    const saveBtn = document.getElementById("save-btn");
    const saveStatus = document.getElementById("save-status");

    function b64DecodeUnicode(str) {
      return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    function b64EncodeUnicode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    // Charger éventuellement les creds mémorisés
    (function preloadCreds() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.password) passInput.value = data.password;
        if (data.token) tokenInput.value = data.token;
        rememberCheckbox.checked = true;
      } catch (e) {
        console.warn("Impossible de lire les identifiants stockés :", e);
      }
    })();

    loginBtn.addEventListener("click", async () => {
      const pwd = passInput.value.trim();
      const token = tokenInput.value.trim();

      if (!pwd) {
        authStatus.textContent = "Merci de saisir un mot de passe admin.";
        authStatus.className = "status err";
        return;
      }
      if (!token) {
        authStatus.textContent = "Merci de coller ton token GitHub.";
        authStatus.className = "status err";
        return;
      }

      adminPassword = pwd;
      githubToken = token;

      // Option : mémoriser localement
      if (rememberCheckbox.checked) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            password: adminPassword,
            token: githubToken
          }));
        } catch (e) {
          console.warn("Impossible de stocker les identifiants :", e);
        }
      } else {
        localStorage.removeItem(STORAGE_KEY);
      }

      authStatus.textContent = "Chargement des actus...";
      authStatus.className = "status";

      try {
        const res = await fetch(
          `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`,
          {
            headers: {
              "Authorization": `Bearer ${githubToken}`,
              "Accept": "application/vnd.github.v3+json`
            }
          }
        );

        if (!res.ok) {
          const txt = await res.text();
          authStatus.textContent = "Erreur GitHub (" + res.status + ") : " + txt;
          authStatus.className = "status err";
          return;
        }

        const data = await res.json();
        currentSha = data.sha;
        const jsonText = b64DecodeUnicode(data.content);
        let parsed;
        try {
          parsed = JSON.parse(jsonText);
        } catch (e) {
          authStatus.textContent = "Le JSON actuel est invalide.";
          authStatus.className = "status err";
          return;
        }

        stateActualites = Array.isArray(parsed.actualites) ? parsed.actualites : [];

        if (!stateActualites.length) {
          stateActualites.push({
            titre: "",
            date: "",
            paragraphes: [],
            promo: false,
            promoCode: ""
          });
        }

        authStatus.textContent = "Actus chargées. Tu es connecté.";
        authStatus.className = "status ok";
        editorSection.style.display = "block";
        renderActus();
      } catch (err) {
        authStatus.textContent = "Erreur réseau : " + err.message;
        authStatus.className = "status err";
      }
    });

    function renderActus() {
      actusContainer.innerHTML = "";
      stateActualites.forEach((a, index) => {
        const card = document.createElement("div");
        card.className = "actu-card";

        const header = document.createElement("div");
        header.className = "actu-header";
        header.innerHTML = `<span class="badge">Actu #${index + 1}</span>`;

        const delBtn = document.createElement("button");
        delBtn.className = "btn danger";
        delBtn.type = "button";
        delBtn.textContent = "Supprimer";
        delBtn.onclick = () => {
          if (stateActualites.length === 1) {
            alert("Garde au moins une actualité.");
            return;
          }
          stateActualites.splice(index, 1);
          renderActus();
        };

        header.appendChild(delBtn);
        card.appendChild(header);

        const labelTitre = document.createElement("label");
        labelTitre.textContent = "Titre :";
        const inputTitre = document.createElement("input");
        inputTitre.value = a.titre || "";
        inputTitre.oninput = e => a.titre = e.target.value;

        const labelDate = document.createElement("label");
        labelDate.textContent = "Date (YYYY-MM-DD) pour le badge “Nouveau !” :";
        const inputDate = document.createElement("input");
        inputDate.placeholder = "2025-11-13";
        inputDate.value = a.date || "";
        inputDate.oninput = e => a.date = e.target.value;

        const labelPara = document.createElement("label");
        labelPara.textContent = "Paragraphes (un par ligne) :";
        const textareaPara = document.createElement("textarea");
        textareaPara.className = "small";
        textareaPara.value = Array.isArray(a.paragraphes) ? a.paragraphes.join("\n") : "";
        textareaPara.oninput = e => {
          a.paragraphes = e.target.value
            .split("\n")
            .map(p => p.trim())
            .filter(p => p.length > 0);
        };

        const checkboxRow = document.createElement("div");
        checkboxRow.className = "checkbox-row";
        const promoCheckbox = document.createElement("input");
        promoCheckbox.type = "checkbox";
        promoCheckbox.checked = !!a.promo;
        promoCheckbox.onchange = e => a.promo = e.target.checked;
        const promoLabel = document.createElement("label");
        promoLabel.textContent = "Afficher un code promo pour cette actu";
        checkboxRow.appendChild(promoCheckbox);
        checkboxRow.appendChild(promoLabel);

        const labelCode = document.createElement("label");
        labelCode.textContent = "Code promo :";
        const inputCode = document.createElement("input");
        inputCode.placeholder = "Ex : ASV-5WEB";
        inputCode.value = a.promoCode || "";
        inputCode.oninput = e => a.promoCode = e.target.value;

        card.appendChild(labelTitre);
        card.appendChild(inputTitre);
        card.appendChild(labelDate);
        card.appendChild(inputDate);
        card.appendChild(labelPara);
        card.appendChild(textareaPara);
        card.appendChild(checkboxRow);
        card.appendChild(labelCode);
        card.appendChild(inputCode);

        actusContainer.appendChild(card);
      });
    }

    addActuBtn.addEventListener("click", () => {
      stateActualites.push({
        titre: "",
        date: "",
        paragraphes: [],
        promo: false,
        promoCode: ""
      });
      renderActus();
    });

    saveBtn.addEventListener("click", async () => {
      if (!githubToken) {
        saveStatus.textContent = "Token GitHub manquant. Reconnecte-toi en haut.";
        saveStatus.className = "status err";
        return;
      }

      saveStatus.textContent = "Enregistrement en cours...";
      saveStatus.className = "status";

      const payloadJson = JSON.stringify({ actualites: stateActualites }, null, 2);
      const contentB64 = b64EncodeUnicode(payloadJson);

      try {
        const res = await fetch(
          `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`,
          {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${githubToken}`,
              "Accept": "application/vnd.github.v3+json`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: "Update actus via admin GitHub Pages",
              content: contentB64,
              sha: currentSha,
              branch: BRANCH
            })
          }
        );

        if (!res.ok) {
          const txt = await res.text();
          saveStatus.textContent = "Erreur GitHub (" + res.status + ") : " + txt;
          saveStatus.className = "status err";
          return;
        }

        const data = await res.json();
        currentSha = data.content.sha;
        saveStatus.textContent = "✅ Actualités mises à jour sur GitHub.";
        saveStatus.className = "status ok";
      } catch (err) {
        saveStatus.textContent = "Erreur réseau : " + err.message;
        saveStatus.className = "status err";
      }
    });
  </script>
</body>
</html>
